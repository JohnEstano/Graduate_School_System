import{r as n,j as e}from"./app-BDkuJsct.js";import{D as ee,a as re,d as se,b as ae,c as te}from"./dialog-DeUj0iLU.js";import{B as d}from"./button-DggClj9M.js";import{S as ie,U as ne}from"./scroll-area-CWTliVrd.js";import{S as w}from"./separator-DaKqQg6m.js";import{A,a as L}from"./alert-CzZoorjr.js";import{L as p}from"./label-MiJboLk1.js";import{I as oe}from"./input-BmPXXlp0.js";import{S as De}from"./index-BrbnoEXB.js";import{t}from"./index-By5vkq0G.js";import{E as Te}from"./eye-BIV30vbs.js";import{S as ke}from"./signature-B6fTe-ja.js";import{L as f}from"./loader-circle-xEC7kKhV.js";import{S as Pe}from"./send-9CEFXyiZ.js";import{R as Ue}from"./refresh-cw-B6toqFMV.js";import{C as _}from"./circle-alert-BxXeSR-n.js";import{C as E}from"./check-BUlQxyEc.js";import{P as Ae}from"./pencil-BymrdZQ3.js";import{F as le}from"./file-text-rxgzo2tt.js";import{T as Le}from"./trash-2-CUp06ccZ.js";import"./index-CWqpdCTP.js";import"./index-BhbofC_p.js";import"./index-B_a1aFVM.js";import"./index-D-bfryUZ.js";import"./utils-jAU0Cazi.js";import"./x-CtfT_1vN.js";import"./createLucideIcon-CEmaZ7tj.js";import"./index-DZZQifJx.js";import"./index-LRezjsDo.js";import"./typeof-QjJsDpFa.js";import"./index-CoS1vLG5.js";import"./index-Chjiymov.js";function xr({open:F,onOpenChange:O,defenseRequest:a,coordinatorId:I,coordinatorName:ce="Coordinator",onApproveComplete:G}){const[h,g]=n.useState("preview"),[o,y]=n.useState(null),[W,$]=n.useState(!1),[z,C]=n.useState(!1),[K,D]=n.useState(!1),[M,de]=n.useState([]),[j,me]=n.useState(null),[ue,X]=n.useState(!1),[he,b]=n.useState(!1),[Y,B]=n.useState(!1),x=n.useRef(null),[m,T]=n.useState(null),[H,_e]=n.useState(!1),[xe,k]=n.useState(!1),J=n.useRef(null),[u,Q]=n.useState(""),[P,V]=n.useState(""),[Ee,pe]=n.useState([]),[Z,R]=n.useState(null);function v(){var r;return((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content)||""}n.useEffect(()=>{F?(fe(),ge(),U(),Q(ce||""),V("Program Coordinator")):(o&&o.startsWith("blob:")&&URL.revokeObjectURL(o),y(null),g("preview"),T(null))},[F]);async function fe(){var r;try{const s=await fetch("/api/document-templates");if(s.ok){const i=await s.json();pe(i);const l=((r=a==null?void 0:a.defense_type)==null?void 0:r.toLowerCase())||"",c=i.find(N=>{const S=N.name.toLowerCase();return l.includes("prefinal")||l.includes("pre-final")?S.includes("prefinal")||S.includes("pre-final"):l.includes("final")?S.includes("final")&&!S.includes("prefinal"):!1});c?R(c):i.length>0&&R(i[0])}}catch(s){console.error("Failed to load templates:",s)}}async function ge(){var s;const r=((s=a==null?void 0:a.attachments)==null?void 0:s.endorsement_form)||(a==null?void 0:a.endorsement_form);if(!r){t.error("No endorsement form found. The adviser must submit the endorsement first.");return}$(!0);try{const i=r.startsWith("/storage/")?r:`/storage/${r}`;console.log("ðŸ“„ Loading endorsement form from:",i);const l=await fetch(i);if(!l.ok)throw new Error("Failed to load endorsement form");const c=await l.blob(),N=URL.createObjectURL(c);y(N),console.log("âœ… Endorsement form loaded successfully"),t.success("Endorsement form loaded successfully!")}catch(i){console.error("âŒ Failed to load endorsement form:",i),t.error("Failed to load endorsement form")}finally{$(!1)}}async function U(){X(!0);try{const r=await fetch("/api/signatures");if(r.ok){const s=await r.json();de(s);const i=s.find(l=>l.active);me(i||null)}}catch(r){console.error("Failed to load signatures:",r)}finally{X(!1)}}async function je(){if(!Z){t.error("No template selected");return}if(!(a!=null&&a.id)){t.error("Invalid defense request");return}if(!u.trim()){t.error("Please enter your full name");return}D(!0);try{const r=await fetch("/api/generate-document",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/pdf","X-CSRF-TOKEN":v()},body:JSON.stringify({template_id:Z.id,defense_request_id:a.id,fields:{"coordinator.full_name":u,"coordinator.title":P},role:"coordinator"})});if(!r.ok){t.error("Failed to generate document"),D(!1);return}const s=await r.blob();o&&o.startsWith("blob:")&&URL.revokeObjectURL(o);const i=URL.createObjectURL(s);y(i),t.success("Endorsement form generated successfully with coordinator info!")}catch(r){console.error("Generate error:",r),t.error("Failed to generate endorsement form")}finally{D(!1)}}async function ve(r){var i;const s=(i=r.target.files)==null?void 0:i[0];if(s){if(!s.type.includes("pdf")){t.error("Please upload a PDF file");return}T(s),t.success('File selected. Click "Use This File" to continue.')}}function Ne(r){r.preventDefault(),k(!0)}function we(r){r.preventDefault(),k(!1)}function ye(r){var i;r.preventDefault(),k(!1);const s=(i=r.dataTransfer.files)==null?void 0:i[0];if(s){if(!s.type.includes("pdf")){t.error("Please upload a PDF file");return}T(s),t.success('File selected. Click "Use This File" to continue.')}}async function be(){if(!m){t.error("No file selected");return}o&&o.startsWith("blob:")&&URL.revokeObjectURL(o);const r=URL.createObjectURL(m);y(r),g("preview"),t.success("Uploaded file ready for preview")}async function Se(){if(!x.current)return;const r=x.current.getCanvas(),s=document.createElement("canvas");s.width=r.width,s.height=r.height;const i=s.getContext("2d");i&&i.drawImage(r,0,0);const l=s.toDataURL("image/png");B(!0);try{(await fetch("/api/signatures",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v()},body:JSON.stringify({image_base64:l,label:"Drawn Signature",natural_width:r.width,natural_height:r.height})})).ok?(t.success("Signature saved successfully!"),b(!1),U()):t.error("Failed to save signature")}catch(c){console.error("Save signature error:",c),t.error("Failed to save signature")}finally{B(!1)}}async function Fe(r){try{(await fetch(`/api/signatures/${r}/activate`,{method:"PATCH",headers:{"X-CSRF-TOKEN":v()}})).ok?(t.success("Signature activated!"),U()):t.error("Failed to activate signature")}catch(s){console.error("Activate signature error:",s),t.error("Failed to activate signature")}}async function Ce(){if(!o&&!m){t.error("Please generate or upload an endorsement form first");return}if(!j){t.error("Please set an active signature first");return}if(!u.trim()){t.error("Please enter your full name");return}C(!0);try{console.log("ðŸš€ Starting coordinator approval process...");const r=new FormData;if(m)r.append("endorsement_form",m,"coordinator-signed-endorsement.pdf");else if(o){const N=await(await fetch(o)).blob();r.append("endorsement_form",N,"endorsement-form-signed.pdf")}r.append("add_coordinator_signature","true"),r.append("coordinator_full_name",u),r.append("coordinator_title",P),console.log("ðŸ“¤ Uploading PDF with coordinator signature overlay...");const s=await fetch(`/api/defense-requests/${a.id}/add-coordinator-signature`,{method:"POST",headers:{"X-CSRF-TOKEN":v(),Accept:"application/json"},body:r});if(!s.ok){const c=await s.text();console.error("âŒ Failed to add coordinator signature:",c),t.error("Failed to sign the endorsement form"),C(!1);return}console.log("âœ… Coordinator signature added successfully");const i={coordinator_status:"Approved"};I&&(i.coordinator_user_id=I),console.log("ðŸ“¤ Updating coordinator status with payload:",i);const l=await fetch(`/coordinator/defense-requirements/${a.id}/coordinator-status`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v()},body:JSON.stringify(i)});if(l.ok){const c=await l.json();console.log("âœ… Approval successful:",c),G&&await G(),O(!1),t.success("Defense request approved successfully!")}else{const c=await l.json();console.error("âŒ Status update failed:",c),t.error(c.message||"Failed to approve request")}}catch(r){console.error("âŒ Approval error:",r),t.error("Failed to approve defense request")}finally{C(!1)}}function q(){if(x.current){const r=x.current.getCanvas(),s=r.getContext("2d");if(s){const l=r.height-80;s.save(),s.strokeStyle="#d1d5db",s.lineWidth=1,s.beginPath(),s.moveTo(40,l),s.lineTo(r.width-40,l),s.stroke(),s.restore()}}}return e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:F,onOpenChange:O,children:e.jsx(re,{className:"flex h-[95vh] w-full max-w-5xl flex-col p-0 gap-0 overflow-hidden",children:e.jsxs("div",{className:"flex flex-1 min-h-0",children:[e.jsxs("div",{className:"w-72 border-r bg-muted/30 flex flex-col shrink-0",children:[e.jsx("div",{className:"p-6 pb-4 shrink-0",children:e.jsxs(se,{children:[e.jsx(ae,{className:"text-lg",children:"Approve Defense Request"}),e.jsx(te,{className:"text-xs mt-2",children:"Review the adviser's endorsement and add your signature"})]})}),e.jsx(w,{}),e.jsx(ie,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"px-6 py-4 space-y-6",children:[e.jsxs("nav",{className:"space-y-1",children:[e.jsxs(d,{variant:h==="preview"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>g("preview"),children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),"Preview Document"]}),e.jsxs(d,{variant:h==="signature"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>g("signature"),children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"My Signature"]}),e.jsxs(d,{variant:h==="upload"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>g("upload"),children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Upload File"]})]}),e.jsx(w,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(p,{className:"text-sm font-medium",children:"Coordinator Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(p,{className:"text-xs text-muted-foreground",children:"Full Name *"}),e.jsx(oe,{value:u,onChange:r=>Q(r.target.value),placeholder:"Enter your full name",className:"h-8 text-sm"})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-xs text-muted-foreground",children:"Title"}),e.jsx(oe,{value:P,onChange:r=>V(r.target.value),placeholder:"e.g., Program Coordinator",className:"h-8 text-sm"})]})]})]}),e.jsx(w,{}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Student"}),e.jsxs("div",{className:"font-semibold",children:[a==null?void 0:a.first_name," ",a==null?void 0:a.last_name]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Program"}),e.jsx("div",{className:"font-semibold",children:a==null?void 0:a.program})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Defense Type"}),e.jsx("div",{className:"font-semibold",children:a==null?void 0:a.defense_type})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Thesis Title"}),e.jsx("div",{className:"font-semibold text-wrap",children:a==null?void 0:a.thesis_title})]})]}),e.jsx(w,{}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Adviser Status"}),e.jsx("div",{className:"font-semibold text-green-600",children:(a==null?void 0:a.adviser_status)||"Approved"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Your Action"}),e.jsx("div",{className:"font-semibold text-amber-600",children:"Pending Approval"})]})]})]})}),e.jsx(w,{}),e.jsxs("div",{className:"p-6 pt-4 shrink-0",children:[e.jsx(d,{className:"w-full",size:"lg",disabled:!o&&!m||!j||z||!u.trim(),onClick:Ce,children:z?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Approving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),"Approve & Sign"]})}),!j&&e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Please set an active signature first"}),!o&&!m&&e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Generate or upload an endorsement form"}),!u.trim()&&e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Enter your full name above"})]})]}),e.jsx("div",{className:"flex-1 flex flex-col min-w-0 overflow-hidden",children:e.jsx(ie,{className:"flex-1",children:e.jsxs("div",{className:"p-8 max-w-5xl mx-auto",children:[W&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-[600px] space-y-4",children:[e.jsx(f,{className:"h-12 w-12 animate-spin text-primary"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loading Endorsement Form..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Please wait while we load the adviser's endorsement"})]})]}),!W&&h==="preview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Endorsement Form Preview"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Review the endorsement before approving"})]}),e.jsx(d,{variant:"outline",size:"sm",onClick:je,disabled:K||!u.trim(),children:K?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),o?"Regenerate":"Generate"]})})]}),o?e.jsx("div",{className:"border rounded-lg overflow-hidden",style:{height:"700px"},children:e.jsx("iframe",{src:o,className:"w-full h-full",title:"Endorsement Form Preview"})}):e.jsxs(A,{children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx(L,{children:u.trim()?'Click "Generate" to create the endorsement form with your information.':"Please enter your full name in the sidebar, then click Generate."})]})]}),h==="signature"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Manage Your Signature"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your signature will be added to the endorsement form"})]}),j&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{className:"text-sm font-medium",children:"Active Signature"}),e.jsx(E,{className:"h-4 w-4 text-green-600"})]}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-4 flex items-center justify-center",children:e.jsx("img",{src:`/storage/${j.image_path}`,alt:"Active signature",className:"max-h-24 object-contain"})})]}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsx(p,{className:"text-sm font-medium",children:"Draw New Signature"}),e.jsxs(d,{variant:"outline",className:"w-full",onClick:()=>b(!0),children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Draw Signature"]})]}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsx(p,{className:"text-sm font-medium",children:"All Signatures"}),ue?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(f,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):M.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:M.map(r=>e.jsxs("div",{className:`border rounded-lg p-3 space-y-2 ${r.active?"ring-2 ring-primary":""}`,children:[e.jsx("div",{className:"bg-muted/50 rounded p-2 flex items-center justify-center min-h-[60px]",children:e.jsx("img",{src:`/storage/${r.image_path}`,alt:"Signature",className:"max-h-12 object-contain"})}),e.jsx(d,{variant:r.active?"secondary":"outline",size:"sm",className:"w-full",onClick:()=>Fe(r.id),disabled:r.active,children:r.active?"Active":"Set Active"})]},r.id))}):e.jsxs(A,{children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx(L,{children:"No signatures found. Draw one to get started."})]})]})]}),h==="upload"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Upload Endorsement Form"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload a pre-signed PDF if generation doesn't work"})]}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${xe?"border-primary bg-primary/5":"border-muted-foreground/25"}`,onDragOver:Ne,onDragLeave:we,onDrop:ye,children:[e.jsx(ne,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium mb-2",children:"Drag and drop your PDF here, or click to browse"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"Maximum file size: 10MB"}),e.jsx("input",{ref:J,type:"file",accept:"application/pdf",onChange:ve,className:"hidden"}),e.jsxs(d,{variant:"outline",onClick:()=>{var r;return(r=J.current)==null?void 0:r.click()},children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Select PDF File"]})]}),m&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:m.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(m.size/1024/1024).toFixed(2)," MB"]})]})]})}),e.jsx(d,{className:"w-full",onClick:be,disabled:H,children:H?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Use This File"]})})]}),e.jsxs(A,{children:[e.jsx(_,{className:"h-4 w-4"}),e.jsxs(L,{className:"text-xs",children:[e.jsx("strong",{children:"Note:"})," The uploaded file should already contain the adviser's signature and endorsement. Your coordinator signature will be added on top of it."]})]})]})]})})})]})})}),e.jsx(ee,{open:he,onOpenChange:b,children:e.jsxs(re,{className:"max-w-4xl",children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Draw Your Signature"}),e.jsx(te,{children:"Draw your signature below. This will replace any existing signatures."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-lg p-4 bg-muted/30",children:e.jsx(De,{ref:x,penColor:"black",backgroundColor:"rgba(0,0,0,0)",minWidth:2,maxWidth:4,velocityFilterWeight:.7,canvasProps:{width:690,height:300,className:"border border-border rounded bg-background w-full",style:{cursor:"crosshair"}},onEnd:q})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(d,{variant:"outline",onClick:()=>{var r;(r=x.current)==null||r.clear(),q()},children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"Clear"]}),e.jsx(d,{variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e.jsx(d,{onClick:Se,disabled:Y,children:Y?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Save Signature"]})})]})]})]})})]})}export{xr as default};
