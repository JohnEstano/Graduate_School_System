import{r as d,j as e,L as O,S as k}from"./app-DW0Mt5c9.js";import{A as Y}from"./app-layout-CPwLq_xH.js";import{d as V}from"./dayjs.min-D31ZKPdx.js";import{T as ue,t as f}from"./index-ByTeG7FR.js";import{B as m}from"./button-BZf0VdIO.js";import{B as pe}from"./badge-B7OUzsXL.js";import{S as C}from"./separator-4d5ucxHB.js";import{A as he,a as je}from"./avatar-B3rD_VQk.js";import{D as ge,a as ve,b as be,c as Ne}from"./dialog-D7L72BhV.js";import{T as W,a as ye,b as H,c as K}from"./tabs-3Dm9feNm.js";import{I as we}from"./input-Ch6RmxP_.js";import{T as _e,a as ke,b as X,c as J,d as Ce,e as G}from"./table-CYsX4eCK.js";import Ae from"./endorsement-dialog-pPtl9oY4.js";import{A as Re}from"./arrow-left-DClE7kxt.js";import{F as p}from"./file-text-Dpj0IN7n.js";import{C as Se}from"./circle-check-big-CG9wjNDm.js";import{C as A}from"./circle-x-C4V9EZEC.js";import{C as D}from"./circle-arrow-left-BUa1uPht.js";import{U as Q}from"./users-CFj_s0Ga.js";import{C as T}from"./clock-CNQjyXBL.js";import{S as De}from"./send-BUfb6BoG.js";import{U as Te}from"./user-check-CRf546ie.js";import{S as Pe}from"./signature-D_iqDcqD.js";import"./index-RzYQM1sh.js";import"./index-DZZQifJx.js";import"./utils-jAU0Cazi.js";import"./index-BMNAwHVU.js";import"./index-DHu7YzAG.js";import"./index-Bh88FqJG.js";import"./x-CW6T59GI.js";import"./createLucideIcon-S0dKkUVo.js";import"./tooltip-3yEC6fE6.js";import"./floating-ui.react-dom-DEJ-U2zP.js";import"./chevron-right-x7vIKCyG.js";import"./dropdown-menu-FJcetjAu.js";import"./index-dxfJWdT_.js";import"./index-I9YLalqX.js";import"./index-xrb8sl6P.js";import"./index-Au_TdUcj.js";import"./index-Bwn0NV8Z.js";import"./check-C1Ca0PY3.js";import"./settings-DPsrAkv5.js";import"./graduation-cap-d15gjgNL.js";import"./dollar-sign-DVIUp7aq.js";import"./credit-card-Bzx9FpUt.js";import"./info-Dl-vg0Zq.js";import"./sun-C_6rnlvD.js";import"./alert-Dap4gtF9.js";import"./label-Dk8neUpq.js";import"./index-CPs87JPB.js";import"./typeof-QjJsDpFa.js";import"./index-BbbQjtbf.js";import"./index-Chjiymov.js";import"./eye-CiUjArwd.js";import"./loader-circle-EY4lXEgZ.js";import"./circle-alert-CV2dla6l.js";import"./pencil-C6zzAshF.js";import"./trash-2-lOnE2GCJ.js";function Us(u){var B;const l=u||{},o=l.defenseRequest||null;l.userRole;const[g,q]=d.useState("details"),R=[{title:"Dashboard",href:"/dashboard"},{title:"All Defense Requirements",href:"/all-defense-requirements"}];if(o!=null&&o.id){const s=(((B=o.thesis_title)==null?void 0:B.length)||0)>60?o.thesis_title.slice(0,57)+"...":o.thesis_title||`Request #${o.id}`;R.push({title:s,href:`/adviser/defense-requirements/${o.id}/details`})}if(!o)return e.jsxs(Y,{breadcrumbs:R,children:[e.jsx(O,{title:"Defense Request - Not Found"}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("p",{className:"text-sm text-red-500",children:"No defense request loaded. Use the list page and click Details again."}),e.jsx(m,{variant:"outline",onClick:()=>k.visit("/all-defense-requirements"),children:"Back to list"})]})]});const[t,v]=d.useState(o),[y,b]=d.useState({open:!1,action:null}),[ee,F]=d.useState(!1),[w,E]=d.useState(!1),[h,z]=d.useState(null),[_,M]=d.useState(!1),N=d.useRef(null);async function se(s){if(!t.id)return;E(!0);let a="Pending";s==="reject"?a="Rejected":s==="retrieve"&&(a="Pending");try{const r={adviser_status:a},n=await P(`/adviser/defense-requirements/${t.id}/adviser-status`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(r)}),i=await n.json();n.ok?(i.request?v(i.request):v(c=>({...c,adviser_status:a,workflow_history:i.workflow_history||c.workflow_history,workflow_state:i.workflow_state||c.workflow_state})),f.success(`Adviser status set to ${a}`)):f.error((i==null?void 0:i.error)||"Failed to update adviser status")}catch{f.error("Network error updating adviser status")}finally{E(!1),b({open:!1,action:null})}}function te(s){var n,i,c,S;const a=((i=(n=s.first_name)==null?void 0:n.trim())==null?void 0:i[0])??"",r=((S=(c=s.last_name)==null?void 0:c.trim())==null?void 0:S[0])??"";return(a+r).toUpperCase()||"U"}function U(s){if(!s)return"—";try{return V(s).format("YYYY-MM-DD hh:mm A")}catch{return s}}function re(s){return s?/approved/i.test(s)?"bg-green-100 text-green-600":/reject/i.test(s)?"bg-red-100 text-red-600":"bg-amber-100 text-amber-600":"bg-gray-100 text-gray-600"}function j(s){return s?/^https?:\/\//i.test(s)||s.startsWith("/storage/")?s:`/storage/${s.replace(/^\/?storage\//,"")}`:null}const $=[{label:"Adviser’s Endorsement",url:j(t.advisers_endorsement)},{label:"REC Endorsement",url:j(t.rec_endorsement)},{label:"Proof of Payment",url:j(t.proof_of_payment)},{label:"Reference No.",url:t.reference_no},{label:"Manuscript",url:j(t.manuscript_proposal)},{label:"Similarity Index",url:j(t.similarity_index)},{label:"Avisee-Adviser File",url:j(t.avisee_adviser_attachment)}],ae=[{key:"submitted",label:"Submitted",icon:e.jsx(De,{className:"h-5 w-5"})},{key:"adviser-approved",label:"Endorsed by Adviser",icon:e.jsx(Te,{className:"h-5 w-5"})},{key:"adviser-rejected",label:"Rejected by Adviser",icon:e.jsx(A,{className:"h-5 w-5"})},{key:"adviser-retrieved",label:"Retrieved by Adviser",icon:e.jsx(D,{className:"h-5 w-5"})},{key:"coordinator-approved",label:"Approved by Coordinator",icon:e.jsx(Pe,{className:"h-5 w-5"})},{key:"coordinator-rejected",label:"Rejected by Coordinator",icon:e.jsx(A,{className:"h-5 w-5"})},{key:"coordinator-retrieved",label:"Retrieved by Coordinator",icon:e.jsx(D,{className:"h-5 w-5"})},{key:"panels-assigned",label:"Panels Assigned",icon:e.jsx(Q,{className:"h-5 w-5"})},{key:"scheduled",label:"Scheduled",icon:e.jsx(T,{className:"h-5 w-5"})}];function ie(s){return s=(s||"").toLowerCase(),s==="submitted"?"submitted":s==="adviser-approved"?"adviser-approved":s==="adviser-rejected"?"adviser-rejected":s==="adviser-retrieved"?"adviser-retrieved":s==="adviser-review"||s==="pending"?"adviser-pending":s==="coordinator-approved"?"coordinator-approved":s==="coordinator-rejected"?"coordinator-rejected":s==="coordinator-retrieved"?"coordinator-retrieved":s==="panels-assigned"?"panels-assigned":s==="scheduled"?"scheduled":""}function ne(s){if(!s)return"";try{return V(s).format("YYYY-MM-DD hh:mm A")}catch{return s}}async function le(s){if(s.preventDefault(),!t.id)return;if(!h){f.error("Please select a file to upload.");return}const a=new FormData;a.append("ai_detection_certificate",h);try{M(!0);const r=await P(`/adviser/defense-requirements/${t.id}/documents`,{method:"POST",body:a}),n=await r.json();r.ok?(v(i=>({...i,ai_detection_certificate:n.ai_detection_certificate||i.ai_detection_certificate})),z(null),N.current&&(N.current.value=""),f.success("AI Detection Certificate uploaded successfully.")):f.error((n==null?void 0:n.error)||"Failed to upload certificate.")}catch{f.error("Network error uploading certificate.")}finally{M(!1)}}const I="rounded-lg border p-5 space-y-3";function oe(s){return s==="Approved"?"Endorsed":s==="Rejected"?"Rejected":s||"—"}function de(s){return s==="Approved"?"Approved":s==="Rejected"?"Rejected":s||"—"}const x=l.coordinators??[],[ce,me]=d.useState([]),[qe,L]=d.useState(!1);d.useEffect(()=>{let s=!0;async function a(){L(!0);try{const r=await fetch("/api/panel-members",{headers:{Accept:"application/json"}});if(r.ok){const n=await r.json();s&&me(Array.isArray(n)?n:[])}}catch(r){console.warn("Failed to load panel members",r)}finally{s&&L(!1)}}return a(),()=>{s=!1}},[]);function xe(s){return s?ce.find(a=>a.name===s):null}return e.jsxs(Y,{breadcrumbs:R,children:[e.jsx(ue,{position:"bottom-right",richColors:!0,closeButton:!0}),e.jsxs("div",{className:"p-5 space-y-6",children:[e.jsx(O,{title:t.thesis_title||`Defense Request #${t.id}`}),e.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:"outline",onClick:()=>k.visit("/all-defense-requirements"),className:"h-8 px-2",children:e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(W,{value:g,onValueChange:s=>q(s),children:e.jsxs(ye,{className:"h-8",children:[e.jsxs(H,{value:"details",className:"flex items-center gap-1 text-sm font-medium px-3",children:[e.jsx(p,{className:"h-4 w-4"})," Details"]}),e.jsxs(H,{value:"upload-certificate",className:"flex items-center gap-1 text-sm font-medium px-3",children:[e.jsx(p,{className:"h-4 w-4"})," Upload AI Certificate"]})]})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{size:"sm",variant:"outline",onClick:()=>F(!0),disabled:w||t.adviser_status==="Approved"||!x.length||!x[0].id,children:[e.jsx(Se,{className:"h-4 w-4 mr-1 text-green-600"}),"Endorse"]}),e.jsxs(m,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"reject"}),disabled:w||t.adviser_status==="Rejected",children:[e.jsx(A,{className:"h-4 w-4 mr-1 text-red-600"}),"Reject"]}),e.jsxs(m,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"retrieve"}),disabled:w||t.adviser_status==="Pending",children:[e.jsx(D,{className:"h-4 w-4 mr-1 text-blue-600"}),"Retrieve"]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-5 mb-2",children:[e.jsx("div",{className:"w-full md:max-w-3xl mx-auto flex flex-col gap-5",children:e.jsxs(W,{value:g,onValueChange:s=>q(s),className:"w-full",children:[e.jsxs(K,{value:"details",className:"space-y-5",children:[e.jsxs("div",{className:"rounded-xl border p-8 bg-white dark:bg-zinc-900",children:[e.jsxs("div",{className:"mb-1 flex flex-col md:flex-row md:items-center md:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-semibold",children:t.thesis_title}),e.jsx("div",{className:"text-xs text-muted-foreground font-medium mt-0.5",children:"Thesis Title"})]}),e.jsx("div",{className:"flex flex-col md:items-end gap-1",children:e.jsxs("span",{className:`text-xs font-semibold px-2 py-0.5 rounded-full mt-2 md:mt-0 ${t.adviser_status==="Approved"?"bg-green-100 text-green-600":t.adviser_status==="Rejected"?"bg-red-100 text-red-600":t.adviser_status==="Pending"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:["Adviser Status: ",oe(t.adviser_status)]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6 mt-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Presenter"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"h-8 w-8",children:e.jsx(je,{className:"text-base font-bold bg-zinc-200 dark:bg-zinc-800 text-zinc-700 dark:text-zinc-200",children:te(t)})}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm leading-tight",children:[t.first_name," ",t.middle_name?`${t.middle_name} `:"",t.last_name]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:t.school_id})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Program"}),e.jsx("div",{className:"font-medium text-sm",children:t.program})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Defense Type"}),e.jsx(pe,{variant:"secondary",className:"text-xs font-medium",children:t.defense_type??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Submitted At"}),e.jsx("div",{className:"font-medium text-sm",children:U(t.submitted_at)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Program Coordinator"}),e.jsx("div",{className:"font-medium text-sm",children:x.length>0?x.map((s,a)=>e.jsxs("div",{className:"text-sm",children:[s.name,s.email?` (${s.email})`:""]},a)):e.jsx("span",{className:"italic text-zinc-400",children:"No coordinator registered"})})]}),e.jsxs("div",{className:"",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Coordinator Status"}),e.jsx("div",{children:e.jsx("span",{className:`text-xs font-semibold px-2 py-0.5 rounded-full inline-block ${re(t.coordinator_status)}`,children:de(t.coordinator_status)})})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(C,{className:"my-2"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Scheduled Date"}),e.jsx("div",{className:"font-medium text-sm",children:U(t.scheduled_date)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Time"}),e.jsx("div",{className:"font-medium text-sm",children:t.scheduled_time?`${t.scheduled_time}${t.scheduled_end_time?" - "+t.scheduled_end_time:""}`:"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Venue"}),e.jsx("div",{className:"font-medium text-sm",children:t.defense_venue||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Mode"}),e.jsx("div",{className:"font-medium text-sm",children:t.defense_mode?t.defense_mode==="face-to-face"?"Face-to-Face":"Online":"—"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Notes"}),e.jsx("div",{className:"font-medium text-sm",children:t.scheduling_notes||"—"})]})]})]}),e.jsxs("div",{className:"rounded-lg border p-5 space-y-3",children:[e.jsxs("h2",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(Q,{className:"h-4 w-4"})," Committee"]}),e.jsx(C,{}),(()=>{const s=(r,n)=>{const i=xe(r);return{displayName:(i==null?void 0:i.name)||r||"—",email:(i==null?void 0:i.email)||"",rawValue:r||"",role:n}},a=[{key:"adviser",info:s(t.defense_adviser,"Adviser")},{key:"chairperson",info:s(t.defense_chairperson,"Chairperson")},{key:"panelist1",info:s(t.defense_panelist1,"Panel Member")},{key:"panelist2",info:s(t.defense_panelist2,"Panel Member")},{key:"panelist3",info:s(t.defense_panelist3,"Panel Member")},{key:"panelist4",info:s(t.defense_panelist4,"Panel Member")}].map(r=>{const n=!!(r.info.rawValue||r.info.displayName&&r.info.displayName!=="—"),i=!!r.info.email,c=n?i?"Assigned":"Pending confirmation":"—";return{name:r.info.displayName,email:r.info.email||"—",role:r.info.role,status:c}});return e.jsx("div",{className:"rounded-md  overflow-x-auto",children:e.jsxs(_e,{children:[e.jsx(ke,{children:e.jsxs(X,{children:[e.jsx(J,{className:"min-w-[200px]",children:"Name & Email"}),e.jsx(J,{className:"min-w-[100px]",children:"Role"})]})}),e.jsx(Ce,{children:a.map((r,n)=>e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-sm",children:r.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r.email})]})}),e.jsx(G,{className:"text-xs",children:r.role})]},n))})]})})})()]}),e.jsxs("div",{className:I,children:[e.jsxs("h2",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(p,{className:"h-4 w-4"})," Attachments"]}),e.jsx(C,{}),e.jsxs("div",{className:"space-y-2 text-sm mt-3",children:[$.filter(s=>s.label!=="AI Detection Certificate"&&s.label!=="Endorsement Form").map(s=>s.url?e.jsxs("a",{href:s.label==="Reference No."?void 0:s.url,target:s.label==="Reference No."?void 0:"_blank",rel:s.label==="Reference No."?void 0:"noopener noreferrer",className:"flex items-center gap-2 px-3 py-2 rounded-md border bg-white dark:bg-zinc-900 hover:bg-muted transition",children:[e.jsx(p,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:s.label}),e.jsx("span",{className:"text-xs text-muted-foreground ml-auto truncate max-w-[180px]",children:typeof s.url=="string"&&s.label!=="Reference No."?s.url.split("/").pop():s.url||""})]},s.label):null),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 rounded-md border bg-white dark:bg-zinc-900",children:[e.jsx(p,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"AI Detection Certificate"}),t.ai_detection_certificate?e.jsx("a",{href:t.ai_detection_certificate,target:"_blank",rel:"noopener noreferrer",className:"ml-auto text-xs underline truncate max-w-[180px]",children:t.ai_detection_certificate.split("/").pop()}):e.jsx("span",{className:"ml-auto text-xs text-rose-600 font-semibold",children:"Missing"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 rounded-md border bg-white dark:bg-zinc-900",children:[e.jsx(p,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Endorsement Form"}),t.endorsement_form?e.jsx("a",{href:t.endorsement_form,target:"_blank",rel:"noopener noreferrer",className:"ml-auto text-xs underline truncate max-w-[180px]",children:t.endorsement_form.split("/").pop()}):e.jsx("span",{className:"ml-auto text-xs text-rose-600 font-semibold",children:"Missing"})]}),!$.some(s=>s.url)&&!t.ai_detection_certificate&&!t.endorsement_form&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No attachments."})]})]})]}),e.jsx(K,{value:"upload-certificate",className:"space-y-5",children:e.jsxs("form",{onSubmit:le,className:"space-y-5",children:[e.jsxs("div",{className:I+" text-sm",children:[e.jsxs("h2",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5"})," AI Detection Certificate"]}),e.jsx(C,{}),e.jsx("div",{className:"flex flex-col gap-3 mt-2",children:e.jsxs("div",{className:"grid w-full max-w-sm items-center gap-1.5",children:[e.jsx("label",{htmlFor:"ai-detection-upload",className:"block text-xs font-medium text-zinc-700 dark:text-zinc-200",children:"Upload Certificate"}),t.ai_detection_certificate&&!h?e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx(we,{type:"text",value:t.ai_detection_certificate.split("/").pop()||"",disabled:!0,className:"flex-1 bg-zinc-100 text-zinc-700 cursor-default"}),e.jsx(m,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7",onClick:()=>{v(s=>({...s,ai_detection_certificate:void 0})),N.current&&(N.current.value="")},title:"Remove linked file",children:e.jsx(A,{className:"h-4 w-4 text-black"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"ai-detection-upload",ref:N,type:"file",accept:".pdf,.jpg,.jpeg,.png",className:"flex-1 text-xs file:bg-rose-500 file:text-white file:rounded file:border-0 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:cursor-pointer",style:{maxWidth:220},onChange:s=>{var a;return z(((a=s.target.files)==null?void 0:a[0])||null)},disabled:_}),_&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Uploading..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:h?`Selected: ${h.name}`:null})]})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{type:"submit",className:"gap-2 bg-rose-500 hover:bg-rose-600 text-white",disabled:_||!h,children:_?e.jsx("span",{children:"Uploading..."}):e.jsx("span",{children:"Upload Certificate"})})})]})})]})}),e.jsx("div",{className:"w-full md:w-[340px] flex-shrink-0 space-y-4",children:e.jsxs("div",{className:"rounded-xl border p-5 bg-white dark:bg-zinc-900 h-fit",children:[e.jsxs("h2",{className:"text-xs font-semibold mb-8 flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"})," Workflow Progress"]}),e.jsx("div",{className:"flex flex-col gap-0 relative",children:Array.isArray(t.workflow_history)&&t.workflow_history.length>0?t.workflow_history.map((s,a)=>{let r=s.action;r==="adviser-status-updated"&&s.to_state&&(r=s.to_state),(r==="adviser-review"||r==="pending")&&(r="adviser-review");const n=ie(r),i=ae.find(fe=>fe.key===n)||{label:r.charAt(0).toUpperCase()+r.slice(1),icon:e.jsx(T,{className:"h-5 w-5 text-gray-500"})},c=a===(t.workflow_history??[]).length-1;return e.jsxs("div",{className:"flex items-start gap-3 relative",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-9 h-9 rounded-md flex items-center justify-center bg-gray-100 text-gray-500",children:i.icon}),!c&&e.jsx("div",{className:"h-8 border-l-2 border-dotted border-gray-300 dark:border-zinc-700 mx-auto"})]}),e.jsxs("div",{className:"pb-4",children:[e.jsx("div",{className:"font-semibold text-xs",children:i.label}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[s.user_name&&e.jsx("span",{children:s.user_name}),s.timestamp&&e.jsxs("span",{children:[" ","· ",ne(s.timestamp)]})]}),s.comment&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s.comment})]})]},a)}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"No workflow history yet."})})]})})]}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:["Last updated by:"," ",t.last_status_updated_by||"—"," ",t.last_status_updated_at?`(${t.last_status_updated_at})`:""]})]}),e.jsx(ge,{open:y.open,onOpenChange:s=>{s||b({open:!1,action:null})},children:e.jsxs(ve,{children:[e.jsx(be,{children:"Confirm Action"}),e.jsx(Ne,{children:"Apply this status change?"}),e.jsx("div",{className:"mt-3 text-sm space-y-3",children:e.jsxs("p",{children:["Set request to"," ",e.jsx("span",{className:"font-semibold",children:y.action==="reject"?"Rejected":"Pending"}),"?"]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(m,{variant:"ghost",onClick:()=>b({open:!1,action:null}),children:"Cancel"}),e.jsx(m,{onClick:()=>y.action&&se(y.action),disabled:w,children:"Confirm"})]})]})}),e.jsx(Ae,{open:ee,onOpenChange:F,defenseRequest:t,coordinatorId:x.length>0?x[0].id:void 0,coordinatorName:x.length>0?x[0].name:"Coordinator",onEndorseComplete:async()=>{console.log("🔄 onEndorseComplete called, fetching updated data...");try{const s=await fetch(`/api/defense-request/${t.id}`,{headers:{Accept:"application/json"}});if(console.log("📡 API Response status:",s.status),s.ok){const a=await s.json();console.log("✅ Updated defense request data:",a),console.log("🎯 New adviser_status:",a.adviser_status),console.log("🎯 New workflow_state:",a.workflow_state),v({...a}),f.success("Endorsement submitted successfully!")}else{const a=await s.text();console.error("❌ API request failed:",s.statusText,a),k.reload()}}catch(s){console.error("💥 Error fetching updated data:",s),k.reload()}}})]})}async function P(u,l,o=!0){l.headers={...typeof l.headers=="object"&&l.headers!==null?l.headers:{},"X-CSRF-TOKEN":Z()};const g=await fetch(u,l);return g.status===419&&o?((!l.headers||typeof l.headers!="object")&&(l.headers={}),l.headers["X-CSRF-TOKEN"]=Z(),P(u,l,!1)):g}function Z(){var u;return((u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.content)||""}export{Us as default};
