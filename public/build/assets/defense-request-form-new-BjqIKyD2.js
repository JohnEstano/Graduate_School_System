import{K as Z,r as i,m as ee,j as e}from"./app-cp5Xxmuq.js";import{H as g}from"./heading-small-kTcc9Ebo.js";import{S as se}from"./Stepper-C4ck5SmD.js";import{B as x}from"./button-HcUz4N3c.js";import{D as te,f as re,a as ae,b as ne,c as ie,d as le}from"./dialog-BrgoPxJ8.js";import{I as m}from"./input-CozWEoae.js";import{L as r}from"./label-BLxT7CIS.js";import{S as oe,a as de,b as ce,c as me,d as S}from"./select-TPdSJVhR.js";import{R as he}from"./refresh-ccw-YXtF6Jlg.js";import{P as fe}from"./paperclip-CSU7OLwK.js";import{P as ue}from"./plus-Bna1wD4l.js";import{C as xe}from"./check-BKTDNJDu.js";import"./utils-jAU0Cazi.js";import"./index-BiaJJerR.js";import"./index-DZZQifJx.js";import"./index-DbUO4osX.js";import"./index-BwY1skv1.js";import"./index-BkV9g7de.js";import"./x-ChVMmgUr.js";import"./createLucideIcon-fPg6f676.js";import"./index-DGSzJOj5.js";import"./index-w2GBgPnQ.js";import"./index-KWoA_zXX.js";import"./index-B7grp9yP.js";import"./floating-ui.react-dom-CclZEsZs.js";import"./index-DjkDYLy3.js";import"./chevron-down-CRKR2eDe.js";function Ke(){var F,I,L;const{auth:{user:a}}=Z().props,[$,p]=i.useState(!1),[M,D]=i.useState(!1),[w,f]=i.useState(0),[A,B]=i.useState(null),[E,H]=i.useState(null),[C,P]=i.useState(!1),[N,_]=i.useState([]),[R,v]=i.useState(!1),[K,T]=i.useState(!1),[y,O]=i.useState(!1),t=ee({firstName:(a==null?void 0:a.first_name)||"",middleName:(a==null?void 0:a.middle_name)||"",lastName:(a==null?void 0:a.last_name)||"",schoolId:(a==null?void 0:a.school_id)||"",program:(a==null?void 0:a.program)||"",thesisTitle:"",defenseType:"",advisersEndorsement:null,recEndorsement:null,proofOfPayment:null,referenceNo:"",defenseAdviser:""});i.useEffect(()=>{t.data.defenseAdviser||q()},[]);function q(){P(!0),fetch("/defense-requests/adviser-suggestion").then(s=>s.json()).then(s=>{s!=null&&s.suggestion&&(B(s.suggestion),H(s.source||null),t.data.defenseAdviser||t.setData("defenseAdviser",s.suggestion))}).catch(()=>{}).finally(()=>P(!1))}function k(){fetch("/defense-requests/adviser-candidates").then(s=>s.json()).then(s=>{Array.isArray(s==null?void 0:s.instructors)&&_(s.instructors)}).catch(()=>{})}const U=i.useRef(null),X=i.useRef(null),V=i.useRef(null);function Y(s){const{name:n,files:d}=s.target;d!=null&&d[0]&&t.setData(n,d[0])}function z(){f(s=>{const n=Math.min(s+1,b.length-1);return n===1&&k(),n})}function J(){f(s=>Math.max(s-1,0))}async function W(){var s;if(!y){T(!0),O(!0),t.clearErrors();try{const n=new FormData,d=t.data;Object.keys(d).forEach(l=>{const o=d[l];o!=null&&o!==""&&(o instanceof File?n.append(l,o):n.append(l,String(o)))});const u=(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content,c=await fetch("/defense-request?json=1",{method:"POST",body:n,headers:{Accept:"application/json",...u?{"X-CSRF-TOKEN":u}:{},"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(c.status===419){t.setError("general","Session expired. Please refresh the page and try again.");return}if(c.status===201){p(!0);return}if(c.status===422){const l=await c.json().catch(()=>({}));if(l!=null&&l.errors){const o={};if(Object.entries(l.errors).forEach(([j,h])=>{Array.isArray(h)&&h.length&&(o[j]=h[0])}),Object.keys(o).length){t.setErrors(o);const j=Object.keys(o);j.some(h=>["thesisTitle","defenseType","defenseAdviser"].includes(h))?f(1):j.some(h=>["advisersEndorsement","recEndorsement","proofOfPayment","referenceNo"].includes(h))&&f(2)}}return}if(c.status>=500){t.setError("general","Server error while saving. Please try again.");return}try{const l=await c.json();l!=null&&l.success?p(!0):t.setError("general","Unexpected response. Please verify your data and retry.")}catch{t.setError("general","Unexpected non-JSON response from server.")}}catch{t.setError("general","Network error. Please check your connection and retry.")}finally{O(!1)}}}const G=()=>w===b.length-1?W():z(),b=[{title:"Personal",content:e.jsxs(e.Fragment,{children:[e.jsx(g,{title:"Step 1: Personal Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 pt-3 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(r,{children:"First Name"}),e.jsx(m,{name:"firstName",value:t.data.firstName,onChange:s=>t.setData("firstName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Middle Name"}),e.jsx(m,{name:"middleName",value:t.data.middleName,onChange:s=>t.setData("middleName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Last Name"}),e.jsx(m,{name:"lastName",value:t.data.lastName,onChange:s=>t.setData("lastName",s.target.value)})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(r,{children:"School ID"}),e.jsx(m,{name:"schoolId",value:t.data.schoolId,onChange:s=>t.setData("schoolId",s.target.value)})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(r,{children:"Program"}),e.jsx(m,{name:"program",value:t.data.program,onChange:s=>t.setData("program",s.target.value)})]})]})},{title:"Defense Details",content:e.jsxs(e.Fragment,{children:[e.jsx(g,{title:"Step 2: Defense Request Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-5 pt-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(r,{children:"Thesis / Dissertation Title"}),e.jsx(m,{name:"thesisTitle",value:t.data.thesisTitle,placeholder:"Enter your thesis/dissertation title",onChange:s=>t.setData("thesisTitle",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Type of Defense *"}),e.jsxs(oe,{value:t.data.defenseType,onValueChange:s=>t.setData("defenseType",s),children:[e.jsx(de,{className:"w-full",children:e.jsx(ce,{placeholder:"Select defense type"})}),e.jsxs(me,{children:[e.jsx(S,{value:"Proposal",children:"Proposal Defense"}),e.jsx(S,{value:"Prefinal",children:"Pre-final Defense"}),e.jsx(S,{value:"Final",children:"Final Defense"})]})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(r,{children:"Research Adviser *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{name:"defenseAdviser",value:t.data.defenseAdviser,onChange:s=>{t.setData("defenseAdviser",s.target.value),R||v(!0)},onFocus:()=>{N.length||k(),v(!0)},onBlur:()=>setTimeout(()=>v(!1),150),placeholder:C?"Loading…":"Enter your adviser's full name"}),e.jsx(x,{type:"button",variant:"outline",disabled:C,onClick:q,className:"shrink-0",children:e.jsx(he,{className:"h-4 w-4"})})]}),R&&N.length>0&&e.jsx("div",{className:"mt-1 max-h-40 w-full overflow-auto rounded border bg-white p-1 text-sm shadow",children:N.map(s=>e.jsx("button",{type:"button",onMouseDown:n=>{n.preventDefault(),t.setData("defenseAdviser",s),v(!1)},className:`block w-full rounded px-2 py-1 text-left hover:bg-rose-100 ${s===t.data.defenseAdviser?"bg-rose-50 font-medium":""}`,children:s},s))}),A&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Suggested: ",A," ",E?`(from ${E.replace("-"," ")})`:""]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600",children:[e.jsx("strong",{children:"Important:"})," Only your named adviser will be able to review and approve this request."]})]})]})},{title:"Required Attachments",content:e.jsxs(e.Fragment,{children:[e.jsx(g,{title:"Step 3: Required Attachments"}),[["advisersEndorsement","Adviser's Endorsement",U],["recEndorsement","REC Endorsement",X],["proofOfPayment","Proof of Payment",V]].map(([s,n,d])=>{var u;return e.jsxs("div",{children:[e.jsx(r,{children:n}),e.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[e.jsx(m,{readOnly:!0,value:((u=t.data[s])==null?void 0:u.name)||"",placeholder:"No file chosen",className:"flex-1"}),e.jsxs(x,{type:"button",variant:"outline",onClick:()=>{var c;return(c=d.current)==null?void 0:c.click()},children:[e.jsx(fe,{className:"mr-1 h-4 w-4"}),"Choose File"]}),e.jsx("input",{type:"file",name:s,ref:d,className:"hidden",onChange:Y})]})]},s)}),e.jsxs("div",{children:[e.jsx(r,{children:"Reference No."}),e.jsx(m,{name:"referenceNo",value:t.data.referenceNo,placeholder:"Enter reference number",onChange:s=>t.setData("referenceNo",s.target.value)})]})]})},{title:"Review Submission",content:e.jsxs("div",{className:"w-full space-y-4 pb-5",children:[e.jsx(g,{title:"Step 4: Review Submission"}),e.jsxs("div",{className:"space-y-6 rounded-lg border border-rose-200 bg-rose-50 p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 text-gray-700 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(r,{className:"text-gray-800",children:"Name"}),e.jsx("div",{children:`${t.data.firstName} ${t.data.middleName} ${t.data.lastName}`})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx(r,{className:"text-gray-800",children:"School ID / Program"}),e.jsx("div",{className:"mb-3",children:`${t.data.schoolId} / ${t.data.program}`}),e.jsx(r,{className:"text-gray-800",children:"Thesis Title"}),e.jsx("div",{children:t.data.thesisTitle})]}),e.jsxs("div",{children:[e.jsx(r,{className:"text-gray-800",children:"Defense Type"}),e.jsx("div",{children:t.data.defenseType||"—"})]}),e.jsxs("div",{children:[e.jsx(r,{className:"text-gray-800",children:"Research Adviser"}),e.jsx("div",{children:t.data.defenseAdviser||"—"})]})]}),e.jsxs("div",{children:[e.jsx(r,{className:"text-gray-800",children:"Attachments"}),e.jsxs("ul",{className:"list-inside list-disc text-gray-700",children:[e.jsxs("li",{children:["Adviser's Endorsement: ",((F=t.data.advisersEndorsement)==null?void 0:F.name)||"—"]}),e.jsxs("li",{children:["REC Endorsement: ",((I=t.data.recEndorsement)==null?void 0:I.name)||"—"]}),e.jsxs("li",{children:["Proof of Payment: ",((L=t.data.proofOfPayment)==null?void 0:L.name)||"—"]}),e.jsxs("li",{children:["Reference No.: ",t.data.referenceNo||"—"]})]})]}),e.jsx("div",{className:"rounded border border-blue-200 bg-blue-50 p-4",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Next Step:"})," Upon submission, this request will be sent directly to your research adviser (",t.data.defenseAdviser||"TBD",") for initial review and approval. Once approved by your adviser, it will be forwarded to the Coordinator for final approval and scheduling."]})})]})]})}],Q=Object.keys(t.errors).length>0;return e.jsxs(te,{open:M,onOpenChange:s=>{D(s),s||(f(0),t.reset(),p(!1),T(!1))},children:[e.jsx(re,{asChild:!0,children:e.jsxs(x,{className:"rounded-lg bg-rose-500",children:[e.jsx(ue,{className:"mr-2"})," Submit a Defense Request"]})}),e.jsxs(ae,{className:"flex h-[95vh] w-full max-w-4xl flex-col relative",children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"Submit Defense Request"}),e.jsx(le,{children:"Fill up all necessary information"})]}),$?e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center space-y-6 px-4",children:[e.jsx(xe,{size:48,className:"text-rose-500"}),e.jsx("h2",{className:"text-2xl font-semibold",children:"Request Submitted!"}),e.jsx("p",{className:"text-center text-gray-600 max-w-md",children:"Your defense request has been saved successfully and sent for Adviser review. You will receive a notification once it progresses."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(x,{onClick:()=>D(!1),children:"Close"}),e.jsx(x,{variant:"outline",onClick:()=>{p(!1),f(0),t.reset()},children:"Submit Another"})]})]}):e.jsxs("div",{className:"flex-1 overflow-auto px-4",children:[K&&Q&&e.jsxs("div",{className:"mb-4 rounded border border-rose-300 bg-rose-50 p-3 text-xs text-rose-700",children:[e.jsx("p",{className:"font-semibold mb-1",children:"Please fix the following:"}),e.jsx("ul",{className:"list-disc ml-4 space-y-0.5",children:Object.entries(t.errors).map(([s,n])=>e.jsx("li",{children:n},s))})]}),e.jsx(se,{steps:b,currentStep:w,onNext:G,onPrev:J,loading:y,className:"h-full"})]}),y&&e.jsx("div",{className:"absolute inset-0 bg-white/60 backdrop-blur-sm flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"animate-spin h-8 w-8 rounded-full border-2 border-rose-500 border-t-transparent"})})]})]})}export{Ke as default};
