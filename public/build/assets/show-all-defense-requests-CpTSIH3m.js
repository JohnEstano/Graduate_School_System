import{r as b,j as e}from"./app-cp5Xxmuq.js";import{d as h,C as E,a as H,b as U,r as B}from"./relativeTime-DHBAx5cO.js";import{B as w}from"./button-HcUz4N3c.js";import{D as X,a as J,b as K,c as G,d as Q,e as V}from"./dialog-BrgoPxJ8.js";import{I as Z}from"./input-CozWEoae.js";import{L as q}from"./label-BLxT7CIS.js";import{F as $}from"./file-text-Brb8dGUd.js";import{S as ee}from"./search-BOf2-cFy.js";import{C as se}from"./chevron-down-CRKR2eDe.js";import{X as I}from"./x-ChVMmgUr.js";import{C as L}from"./check-BKTDNJDu.js";import{H as te}from"./hourglass-D3ZOeZeu.js";import{P as re}from"./paperclip-CSU7OLwK.js";import"./index-BwY1skv1.js";import"./index-BiaJJerR.js";import"./index-DZZQifJx.js";import"./utils-jAU0Cazi.js";import"./index-DbUO4osX.js";import"./index-BkV9g7de.js";import"./createLucideIcon-fPg6f676.js";h.extend(B);function x(t){const l=t.middle_name?`${t.middle_name[0].toUpperCase()}. `:"";return`${t.first_name} ${l}${t.last_name}`}const P={pending:{icon:e.jsx(te,{className:"h-4 w-4 opacity-60"}),getDescription:t=>e.jsxs("span",{children:["This defense request for ",e.jsx("b",{children:x(t)})," (",e.jsx("b",{children:t.thesis_title}),") is ",e.jsx("b",{children:"awaiting review"})," by the Coordinator."]}),color:"bg-yellow-100 text-yellow-800 border-yellow-300",bg:"bg-zinc-50"},approved:{icon:e.jsx(L,{className:"h-4 w-4 text-green-600"}),getDescription:t=>e.jsxs("span",{children:["This defense request for ",e.jsx("b",{children:x(t)})," (",e.jsx("b",{children:t.thesis_title}),") has been ",e.jsx("b",{children:"approved"})," by the Coordinator and is ",e.jsx("b",{children:"ready for defense"}),".",e.jsx("br",{}),t.date_of_defense&&e.jsxs("span",{children:["The defense is set on ",e.jsx("b",{children:h(t.date_of_defense).format("MMMM D, YYYY")})]}),t.mode_defense&&e.jsxs("span",{children:[" ","and will be conducted ",e.jsx("b",{children:t.mode_defense}),"."]})]}),color:"bg-green-100 text-green-800 border-green-300",bg:"bg-green-50"},rejected:{icon:e.jsx(I,{className:"h-4 w-4 text-rose-600"}),getDescription:t=>e.jsxs("span",{children:["This defense request for ",e.jsx("b",{children:x(t)})," (",e.jsx("b",{children:t.thesis_title}),") has been ",e.jsx("b",{children:"rejected"})," by the Coordinator. Please review the ",e.jsx("b",{children:"feedback"})," and ",e.jsx("b",{children:"resubmit"})," if necessary."]}),color:"bg-rose-100 text-rose-800 border-rose-300",bg:"bg-rose-50"},"needs-info":{icon:e.jsx($,{className:"h-4 w-4 text-blue-600"}),getDescription:t=>e.jsxs("span",{children:[e.jsx("b",{children:"Additional information"})," is required for this defense request for ",e.jsx("b",{children:x(t)})," (",e.jsx("b",{children:t.thesis_title}),"). Please check the ",e.jsx("b",{children:"comments"})," from the Coordinator and provide the ",e.jsx("b",{children:"requested details"}),"."]}),color:"bg-blue-100 text-blue-800 border-blue-300",bg:"bg-blue-50"}};function De({defenseRequests:t=[],showActions:l=!1,title:N="Defense Requests",description:_="This section shows defense requests"}){const[F,T]=b.useState({}),[z,O]=b.useState(""),[g,A]=b.useState(null),[n,u]=b.useState(null),[y,v]=b.useState("");b.useEffect(()=>{T({})},[t]);async function W(s,c,p){var m;A(s);try{const a=(m=document.querySelector('meta[name="csrf-token"]'))==null?void 0:m.content;if(!a)throw new Error("CSRF token not found");const i=await fetch(`/defense-requests/${s}/adviser-decision`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,Accept:"application/json"},body:JSON.stringify({decision:c,comment:p||""}),credentials:"same-origin"});if(!i.ok){const C=await i.json().catch(()=>({}));alert(`Failed: ${C.message||i.statusText}`);return}(await i.json()).success?window.location.reload():alert("Decision failed.")}catch(a){console.error(a),alert("Network error.")}finally{A(null),u(null)}}const S=t.filter(s=>{var a;const c=x(s).toLowerCase(),p=((a=s.thesis_title)==null?void 0:a.toLowerCase())||"",m=z.toLowerCase();return c.includes(m)||p.includes(m)});return e.jsxs("div",{className:"flex flex-col pb-5 w-full",children:[e.jsxs("div",{className:"w-full bg-white border border-zinc-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"flex flex-row items-center justify-between w-full p-3 border-b bg-white",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 flex items-center justify-center rounded-full bg-blue-500/10 border border-blue-500",children:e.jsx($,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-base font-semibold",children:N}),e.jsx("span",{className:"block text-xs text-muted-foreground",children:_})]})]})}),e.jsx("div",{className:"flex items-center px-4 py-3 border-b bg-white",children:e.jsx(Z,{type:"text",startIcon:ee,placeholder:"Search...",value:z,onChange:s=>O(s.target.value),className:"max-w-xs text-sm py-1 h-8"})}),S.length===0?e.jsx("div",{className:"p-6 text-center text-sm text-muted-foreground bg-white",children:"No defense requests found."}):S.slice().sort((s,c)=>{const p=s.created_at?new Date(s.created_at).getTime():0;return(c.created_at?new Date(c.created_at).getTime():0)-p}).map(s=>{var Y,M,R;const c=((Y=s.status)==null?void 0:Y.toLowerCase())||"pending",p=P[c]||P.pending,m=F[s.id]??!1,a=s.created_at?h(s.created_at).fromNow():"Unknown",i=(s.workflow_state||"").toLowerCase(),f=ie(i),C=ne(f);return e.jsx("div",{className:"border-b border-zinc-200 bg-white",children:e.jsxs(E,{open:m,onOpenChange:r=>T(o=>({...o,[s.id]:r})),children:[e.jsx(H,{asChild:!0,children:e.jsx("div",{className:"group cursor-pointer bg-white hover:bg-zinc-50 transition",children:e.jsxs("div",{className:"p-3 flex items-center gap-4",children:[e.jsx("div",{className:"shrink-0",children:e.jsx(se,{className:`h-4 w-4 text-zinc-500 transition-transform duration-200 ${m?"rotate-180":""}`})}),e.jsx("div",{className:"shrink-0",children:p.icon}),e.jsxs("div",{className:"flex flex-col min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:f==="Waiting for your review"?"Under Adviser Review":f}),e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded-full border ${C}`,children:f})]}),e.jsxs("div",{className:"text-[11px] text-zinc-500 truncate",children:[x(s)," • ",s.thesis_title||"Untitled Thesis"]})]}),e.jsx("div",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:a&&`Submitted ${a}`})]})})}),e.jsx(U,{children:e.jsxs("div",{className:"px-5 pb-6 pt-4 bg-white",children:[e.jsxs("div",{className:"rounded-lg border border-zinc-200 mb-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-6 p-4",children:[e.jsxs("div",{className:"grid gap-6 sm:grid-cols-3 flex-1 min-w-0",children:[e.jsx(k,{label:"Thesis Title",value:s.thesis_title||"—"}),e.jsx(k,{label:"Student Name",value:x(s)}),e.jsx(k,{label:"Adviser",value:s.defense_adviser||"You"})]}),e.jsx("div",{className:"flex flex-col items-end gap-1 shrink-0 text-[11px] text-zinc-500",children:e.jsxs("span",{children:["Submitted ",a]})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 px-4 pb-4",children:[s.manuscript_proposal&&e.jsx(j,{file:s.manuscript_proposal,label:"Manuscript"}),s.similarity_index&&e.jsx(j,{file:s.similarity_index,label:"Similarity"}),s.rec_endorsement&&e.jsx(j,{file:s.rec_endorsement,label:"Endorsement"}),s.proof_of_payment&&e.jsx(j,{file:s.proof_of_payment,label:"Payment"}),s.advisers_endorsement&&e.jsx(j,{file:s.advisers_endorsement,label:"Adviser Endorse."}),!s.manuscript_proposal&&!s.similarity_index&&!s.rec_endorsement&&!s.proof_of_payment&&!s.advisers_endorsement&&e.jsx("span",{className:"text-xs text-zinc-500",children:"No attachments uploaded."})]})]}),(()=>{let r="Pending",o="";!i||["submitted","adviser-review","pending",""].includes(i)?(r="Pending",o=`This defense request for ${x(s)} (${s.thesis_title}) is waiting for your review.`):i==="adviser-approved"?(r="Pending",o="Approved by you. Awaiting Coordinator review."):i==="adviser-rejected"?(r="Rejected",o="You rejected this request. Student will revise and resubmit."):i==="coordinator-approved"||c==="approved"?(r="Approved",o="Coordinator approved. Ready / scheduled for defense."):i==="completed"?(r="Completed",o="Defense process completed."):(r=i,o=`Current state: ${i}.`);const D=r==="Rejected"?"bg-rose-50 text-rose-700 border-rose-100":r==="Approved"?"bg-emerald-50 text-emerald-700 border-emerald-100":r==="Completed"?"bg-indigo-50 text-indigo-700 border-indigo-100":"bg-zinc-50 text-zinc-700 border-zinc-100";return e.jsxs("div",{className:`border ${D} rounded-md px-4 py-3 mb-6`,children:[e.jsx("p",{className:"text-sm font-semibold mb-1",children:r}),e.jsx("p",{className:"text-xs leading-relaxed",children:o})]})})(),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 mb-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(d,{label:"Thesis Title",value:s.thesis_title||"—"}),e.jsx(d,{label:"Student Name",value:x(s)}),e.jsx(d,{label:"Student ID",value:s.school_id||"—"}),e.jsx(d,{label:"Program",value:s.program||"—"}),s.reference_no&&e.jsx(d,{label:"Reference No.",value:s.reference_no})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(d,{label:"Defense Type",value:s.defense_type||"—"}),e.jsx(d,{label:"Adviser",value:s.defense_adviser||"You"}),e.jsx(d,{label:"Submitted",value:a}),e.jsx(d,{label:"Workflow State",value:(s.workflow_state||"pending").toLowerCase()}),s.date_of_defense&&e.jsx(d,{label:"Defense Date",value:h(s.date_of_defense).format("MMMM D, YYYY")}),s.mode_defense&&e.jsx(d,{label:"Mode",value:s.mode_defense})]})]}),(s.adviser_comments||s.coordinator_comments||((M=s.workflow_history)==null?void 0:M.length))&&e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-xs font-semibold mb-2 uppercase tracking-wide text-zinc-500",children:"Workflow History"}),e.jsxs("div",{className:"space-y-2",children:[s.adviser_comments&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-blue-800",children:"Adviser Comment"}),e.jsx("div",{className:"text-xs text-blue-700 mt-1",children:s.adviser_comments}),s.adviser_reviewed_at&&e.jsx("div",{className:"text-[10px] text-blue-600 mt-1",children:h(s.adviser_reviewed_at).format("MMM D, YYYY h:mm A")})]}),s.coordinator_comments&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-green-800",children:"Coordinator Comment"}),e.jsx("div",{className:"text-xs text-green-700 mt-1",children:s.coordinator_comments}),s.coordinator_reviewed_at&&e.jsx("div",{className:"text-[10px] text-green-600 mt-1",children:h(s.coordinator_reviewed_at).format("MMM D, YYYY h:mm A")})]}),(R=s.workflow_history)==null?void 0:R.map((r,o)=>e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsxs("div",{className:"text-[11px] font-semibold text-gray-800",children:[r.action.replace("-"," ").replace(/\b\w/g,D=>D.toUpperCase())," by ",r.user_name]}),r.comment&&e.jsx("div",{className:"text-xs text-gray-700 mt-1",children:r.comment}),e.jsx("div",{className:"text-[10px] text-gray-600 mt-1",children:h(r.timestamp).format("MMM D, YYYY h:mm A")})]},o))]})]}),l&&(i==="adviser-review"||i==="submitted"||i==="pending")&&e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsxs(w,{size:"sm",variant:"outline",className:"text-red-600 border-red-300 hover:bg-red-50",disabled:g===s.id,onClick:()=>u({id:s.id,action:"reject"}),children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),"Reject"]}),e.jsxs(w,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-700",disabled:g===s.id,onClick:()=>u({id:s.id,action:"approve"}),children:[e.jsx(L,{className:"h-3 w-3 mr-1"}),"Approve"]})]})]})})]})},s.id)})]}),n&&e.jsx(X,{open:!0,onOpenChange:()=>{u(null),v("")},children:e.jsxs(J,{className:"max-w-md",children:[e.jsxs(K,{children:[e.jsx(G,{children:n.action==="approve"?"Approve Defense Request":"Reject Defense Request"}),e.jsx(Q,{children:n.action==="approve"?"This defense request will be forwarded to the Coordinator for final approval and scheduling.":"This defense request will be rejected and sent back to the student."})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs(q,{htmlFor:"comments",className:"text-sm font-medium",children:["Comments ",n.action==="reject"?"(Required for rejection)":"(Optional)"]}),e.jsx("textarea",{id:"comments",value:y,onChange:s=>v(s.target.value),placeholder:n.action==="approve"?"Add any feedback or notes for the student...":"Please provide feedback on why this request is being rejected...",className:"w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:4,required:n.action==="reject"})]})}),e.jsxs(V,{children:[e.jsx(w,{variant:"outline",onClick:()=>{u(null),v("")},children:"Cancel"}),e.jsx(w,{onClick:()=>{if(n.action==="reject"&&!y.trim()){alert("Comments are required when rejecting a request.");return}W(n.id,n.action,y),v("")},disabled:g===n.id,className:n.action==="approve"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700",children:g===n.id?"Processing...":n.action==="approve"?"Approve & Forward":"Reject Request"})]})]})})]})}function ie(t){return!t||["submitted","adviser-review","pending",""].includes(t)?"Waiting for your review":t==="adviser-approved"?"Waiting for coordinator":t==="adviser-rejected"?"Rejected":t==="coordinator-approved"?"Approved":t==="completed"?"Completed":"In progress"}function ne(t){return t==="Waiting for your review"?"bg-amber-100 text-amber-700 border-amber-200":t==="Waiting for coordinator"?"bg-blue-100 text-blue-700 border-blue-200":t==="Rejected"?"bg-rose-100 text-rose-700 border-rose-200":t==="Approved"?"bg-emerald-100 text-emerald-700 border-emerald-200":t==="Completed"?"bg-indigo-100 text-indigo-700 border-indigo-200":"bg-zinc-100 text-zinc-700 border-zinc-200"}function d({label:t,value:l}){return e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide font-semibold text-zinc-500 mb-0.5",children:t}),e.jsx("p",{className:"text-sm font-medium break-words",children:l})]})}function k({label:t,value:l}){return e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-zinc-500 font-semibold mb-1",children:t}),e.jsx("p",{className:"text-sm font-semibold truncate",children:l})]})}function j({file:t,label:l}){const N=t.split("/").pop();return e.jsxs("a",{href:`/storage/${t}`,target:"_blank",rel:"noopener noreferrer",onClick:_=>_.stopPropagation(),className:"flex items-center gap-3 rounded-lg border border-zinc-200 bg-white pl-3 pr-4 py-2.5 hover:bg-zinc-50 transition text-xs",children:[e.jsx("span",{className:"h-8 w-8 flex items-center justify-center rounded-md bg-rose-500 text-white",children:e.jsx(re,{className:"h-4 w-4"})}),e.jsxs("span",{className:"flex flex-col leading-tight truncate",children:[e.jsx("span",{className:"font-semibold text-[11px]",children:l}),e.jsx("span",{className:"text-[10px] text-zinc-500 truncate max-w-[120px]",children:N})]})]})}export{De as default};
