import{r as o,j as e}from"./app-BDkuJsct.js";import{D as q,a as ee,d as se,b as ae,c as re}from"./dialog-DeUj0iLU.js";import{B as d}from"./button-DggClj9M.js";import{S as te,U as ne}from"./scroll-area-CWTliVrd.js";import{S as P}from"./separator-DaKqQg6m.js";import{A as E,a as A}from"./alert-CzZoorjr.js";import{L}from"./label-MiJboLk1.js";import{S as Ne}from"./index-BrbnoEXB.js";import{t as r}from"./index-By5vkq0G.js";import{E as be}from"./eye-BIV30vbs.js";import{S as Se}from"./signature-B6fTe-ja.js";import{L as j}from"./loader-circle-xEC7kKhV.js";import{S as Fe}from"./send-9CEFXyiZ.js";import{C as O}from"./circle-alert-BxXeSR-n.js";import{C as _}from"./check-BUlQxyEc.js";import{P as De}from"./pencil-BymrdZQ3.js";import{F as Ce}from"./file-text-rxgzo2tt.js";import{T as Te}from"./trash-2-CUp06ccZ.js";import"./index-CWqpdCTP.js";import"./index-BhbofC_p.js";import"./index-B_a1aFVM.js";import"./index-D-bfryUZ.js";import"./utils-jAU0Cazi.js";import"./x-CtfT_1vN.js";import"./createLucideIcon-CEmaZ7tj.js";import"./index-DZZQifJx.js";import"./index-LRezjsDo.js";import"./typeof-QjJsDpFa.js";import"./index-CoS1vLG5.js";import"./index-Chjiymov.js";function is({open:v,onOpenChange:$,defenseRequest:n,coordinatorId:I,coordinatorName:G="Coordinator",onEndorseComplete:z}){const[p,w]=o.useState("preview"),[l,N]=o.useState(null),[ke,ie]=o.useState(null),[y,C]=o.useState(!1),[K,h]=o.useState(!1),[W,oe]=o.useState([]),[b,le]=o.useState(null),[ce,X]=o.useState(!1),[de,S]=o.useState(!1),[B,H]=o.useState(!1),x=o.useRef(null),[u,T]=o.useState(null),[J,M]=o.useState(!1),[me,F]=o.useState(!1),V=o.useRef(null),[Y,ue]=o.useState([]),[D,Q]=o.useState(null);function g(){var s;return((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||""}o.useEffect(()=>{v?(fe(),k()):(l&&l.startsWith("blob:")&&window.URL.revokeObjectURL(l),N(null),ie(null),w("preview"),T(null),F(!1))},[v]),o.useEffect(()=>{v&&Y.length>0&&D&&!l&&!y&&Z()},[v,Y,D]);async function fe(){var s;try{const a=await fetch("/api/document-templates");if(a.ok){const t=await a.json();ue(t);const i=((s=n==null?void 0:n.defense_type)==null?void 0:s.toLowerCase())||"",c=t.find(f=>{const m=f.name.toLowerCase();return i.includes("prefinal")||i.includes("pre-final")?m.includes("prefinal")||m.includes("pre-final"):i.includes("final")?m.includes("final")&&!m.includes("prefinal"):!1});c?Q(c):t.length>0&&Q(t[0])}}catch(a){console.error("Failed to load templates:",a)}}async function k(){X(!0);try{const s=await fetch("/api/signatures");if(s.ok){const a=await s.json();oe(a);const t=a.find(i=>i.active);le(t||null)}}catch(s){console.error("Failed to load signatures:",s)}finally{X(!1)}}async function Z(){if(!D){r.error("No template selected");return}if(!(n!=null&&n.id)){r.error("Invalid defense request");return}C(!0);try{const s=await fetch("/api/generate-document",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/pdf","X-CSRF-TOKEN":g()},body:JSON.stringify({template_id:D.id,defense_request_id:n.id,fields:{},role:"adviser"})});if(!s.ok){r.error("Failed to generate document"),C(!1);return}const a=await s.blob(),t=window.URL.createObjectURL(a);N(t),r.success('Endorsement form generated successfully! Review and click "Endorse" to submit.')}catch(s){console.error("Generate error:",s),r.error("Failed to generate endorsement form")}finally{C(!1)}}async function pe(){if(!x.current)return;const s=x.current.getCanvas(),a=s.toDataURL("image/png");H(!0);try{(await fetch("/api/signatures",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":g()},body:JSON.stringify({image_base64:a,label:"Drawn Signature",natural_width:s.width,natural_height:s.height})})).ok?(r.success("Signature saved successfully!"),S(!1),k()):r.error("Failed to save signature")}catch(t){console.error("Save signature error:",t),r.error("Failed to save signature")}finally{H(!1)}}async function he(s){try{(await fetch(`/api/signatures/${s}/activate`,{method:"PATCH",headers:{"X-CSRF-TOKEN":g()}})).ok?(r.success("Signature activated!"),k()):r.error("Failed to activate signature")}catch(a){console.error("Activate signature error:",a),r.error("Failed to activate signature")}}async function xe(s){var t;const a=(t=s.target.files)==null?void 0:t[0];if(a){if(!a.type.includes("pdf")){r.error("Please upload a PDF file");return}T(a),r.success('File selected. Click "Use This File" to continue.')}}function ge(s){s.preventDefault(),F(!0)}function je(s){s.preventDefault(),F(!1)}function ve(s){var t;s.preventDefault(),F(!1);const a=(t=s.dataTransfer.files)==null?void 0:t[0];if(a){if(!a.type.includes("pdf")){r.error("Please upload a PDF file");return}T(a),r.success('File selected. Click "Use This File" to continue.')}}async function we(){if(!(!u||!(n!=null&&n.id))){M(!0);try{const s=new Blob([u],{type:"application/pdf"}),a=window.URL.createObjectURL(s);N(a),r.success('Endorsement form uploaded successfully! Review and click "Endorse" to submit.'),w("preview")}catch(s){console.error("Upload error:",s),r.error("Failed to upload endorsement form")}finally{M(!1)}}}async function ye(){if(!l){r.error("Please generate or upload an endorsement form first");return}if(!b){r.error("Please set an active signature first");return}h(!0);try{console.log("🚀 Starting endorsement process...");let s=!1;if(u){console.log("📤 Uploading user-selected file:",u.name);const i=new FormData;i.append("endorsement_form",u);const c=await fetch(`/api/defense-requests/${n.id}/upload-endorsement`,{method:"POST",headers:{"X-CSRF-TOKEN":g(),Accept:"application/json"},body:i});if(console.log("📥 Upload response status:",c.status),c.ok){const f=await c.json();console.log("✅ Upload successful:",f),s=!0}else{const f=await c.text();console.error("❌ Upload failed:",c.status,f),r.error("Failed to save endorsement form: "+c.statusText),h(!1);return}}else if(l){console.log("📤 Uploading generated PDF blob...");try{const c=await(await fetch(l)).blob();console.log("📦 Blob created:",c.type,c.size,"bytes");const f=new FormData;f.append("endorsement_form",c,"endorsement-form.pdf");const m=await fetch(`/api/defense-requests/${n.id}/upload-endorsement`,{method:"POST",headers:{"X-CSRF-TOKEN":g(),Accept:"application/json"},body:f});if(console.log("📥 Upload response status:",m.status),m.ok){const U=await m.json();console.log("✅ Upload successful:",U),s=!0}else{const U=await m.text();console.error("❌ Upload failed:",m.status,U),r.error("Failed to save endorsement form: "+m.statusText),h(!1);return}}catch(i){console.error("❌ Error saving generated PDF:",i),r.error("Failed to save endorsement form"),h(!1);return}}if(!s){console.error("❌ No endorsement form was saved"),r.error("Failed to save endorsement form"),h(!1);return}console.log("✅ Endorsement form saved successfully, updating adviser status...");const a={adviser_status:"Approved"};I&&(a.coordinator_user_id=I),console.log("📤 Updating adviser status with payload:",a);const t=await fetch(`/adviser/defense-requirements/${n.id}/adviser-status`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":g()},body:JSON.stringify(a)});if(console.log("📥 Adviser status update response:",t.status),t.ok){const i=await t.json();console.log("✅ Endorsement successful:",i),z&&await z(),$(!1),r.success(`Request endorsed successfully and forwarded to ${G}!`)}else{const i=await t.json();console.error("❌ Adviser status update failed:",i),r.error(i.message||"Failed to endorse request")}}catch(s){console.error("❌ Endorse error:",s),r.error("Failed to endorse request")}finally{h(!1)}}function R(){if(x.current){const s=x.current.getCanvas(),a=s.getContext("2d");if(a){const i=s.height-80;a.save(),a.strokeStyle="#d1d5db",a.lineWidth=1,a.beginPath(),a.moveTo(40,i),a.lineTo(s.width-40,i),a.stroke(),a.restore()}}}return e.jsxs(e.Fragment,{children:[e.jsx(q,{open:v,onOpenChange:$,children:e.jsx(ee,{className:"flex h-[95vh] w-full max-w-5xl flex-col p-0 gap-0 overflow-hidden",children:e.jsxs("div",{className:"flex flex-1 min-h-0",children:[e.jsxs("div",{className:"w-72 border-r bg-muted/30 flex flex-col shrink-0",children:[e.jsx("div",{className:"p-6 pb-4 shrink-0",children:e.jsxs(se,{children:[e.jsx(ae,{className:"text-lg",children:"Endorse Request"}),e.jsx(re,{className:"text-xs mt-2",children:"Review and endorse the defense request"})]})}),e.jsx(P,{}),e.jsx(te,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"px-6 py-4 space-y-6",children:[e.jsxs("nav",{className:"space-y-1",children:[e.jsxs(d,{variant:p==="preview"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>w("preview"),children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Preview"]}),e.jsxs(d,{variant:p==="signature"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>w("signature"),children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Signature"]}),e.jsxs(d,{variant:p==="upload"?"secondary":"ghost",className:"w-full justify-start",onClick:()=>w("upload"),children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Upload File"]})]}),e.jsx(P,{}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Student"}),e.jsxs("div",{className:"font-semibold",children:[n==null?void 0:n.first_name," ",n==null?void 0:n.last_name]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Defense Type"}),e.jsx("div",{className:"font-semibold",children:n==null?void 0:n.defense_type})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Coordinator"}),e.jsx("div",{className:"font-semibold",children:G})]})]})]})}),e.jsx(P,{}),e.jsx("div",{className:"p-6 pt-4 shrink-0",children:e.jsx(d,{className:"w-full",size:"lg",disabled:!l||!b||K,onClick:ye,children:K?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Endorsing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Endorse to Coordinator"]})})})]}),e.jsx("div",{className:"flex-1 flex flex-col min-w-0 overflow-hidden",children:e.jsx(te,{className:"flex-1",children:e.jsxs("div",{className:"p-8 max-w-5xl mx-auto",children:[y&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-[600px] space-y-4",children:[e.jsx(j,{className:"h-12 w-12 animate-spin text-primary"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Generating Document..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Please wait while we prepare your endorsement form"})]})]}),!y&&p==="preview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Document Preview"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Review the generated endorsement form"})]}),l&&e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{l.startsWith("blob:")&&window.URL.revokeObjectURL(l),N(null),Z()},disabled:y,children:[e.jsx(j,{className:`mr-2 h-4 w-4 ${y?"animate-spin":""}`}),"Regenerate"]})]}),l?e.jsx("div",{className:"border rounded-lg overflow-hidden",style:{height:"700px"},children:e.jsx("iframe",{src:l,className:"w-full h-full",title:"Document Preview"})}):e.jsxs(E,{children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(A,{children:"Document is being generated automatically. Please wait..."})]})]}),p==="signature"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Manage Signature"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"View, draw, or upload your signature"})]}),b&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(L,{className:"text-sm font-medium",children:"Active Signature"}),e.jsx(_,{className:"h-4 w-4 text-green-600"})]}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-4 flex items-center justify-center",children:e.jsx("img",{src:`/storage/${b.image_path}`,alt:"Active signature",className:"max-h-24 object-contain"})})]}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsx(L,{className:"text-sm font-medium",children:"Draw New Signature"}),e.jsxs(d,{variant:"outline",className:"w-full",onClick:()=>S(!0),children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),"Draw Signature"]})]}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsx(L,{className:"text-sm font-medium",children:"All Signatures"}),ce?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(j,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):W.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:W.map(s=>e.jsxs("div",{className:`border rounded-lg p-3 space-y-2 ${s.active?"ring-2 ring-primary":""}`,children:[e.jsx("div",{className:"bg-muted/50 rounded p-2 flex items-center justify-center min-h-[60px]",children:e.jsx("img",{src:`/storage/${s.image_path}`,alt:"Signature",className:"max-h-12 object-contain"})}),e.jsx(d,{variant:s.active?"secondary":"outline",size:"sm",className:"w-full",onClick:()=>he(s.id),disabled:s.active,children:s.active?"Active":"Set Active"})]},s.id))}):e.jsxs(E,{children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(A,{children:"No signatures found. Draw one to get started."})]})]})]}),p==="upload"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Upload Custom File"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload your own endorsement form PDF"})]}),e.jsxs(E,{children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(A,{children:"If you prefer to use your own endorsement form, you can upload it here instead of generating one."})]}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-12 text-center space-y-4 transition-colors ${me?"border-primary bg-primary/5":"border-muted-foreground/25"}`,onDragOver:ge,onDragLeave:je,onDrop:ve,children:[e.jsx(ne,{className:"h-16 w-16 mx-auto text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-medium",children:u?u.name:"Drag and drop your PDF here"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"or click to browse"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PDF files only, max 10MB"})]}),e.jsx("input",{ref:V,type:"file",accept:".pdf",onChange:xe,className:"hidden"}),e.jsxs(d,{variant:"outline",size:"lg",onClick:()=>{var s;return(s=V.current)==null?void 0:s.click()},children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Choose File"]})]}),u&&e.jsx(d,{size:"lg",className:"w-full",onClick:we,disabled:J,children:J?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"mr-2 h-4 w-4"}),"Use This File"]})})]})]})})})]})})}),e.jsx(q,{open:de,onOpenChange:S,children:e.jsxs(ee,{className:"max-w-4xl",children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Draw Your Signature"}),e.jsx(re,{children:"Draw your signature below. This will replace any existing signatures."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-lg p-4 bg-muted/30",children:e.jsx(Ne,{ref:x,penColor:"black",backgroundColor:"rgba(0,0,0,0)",minWidth:2,maxWidth:4,velocityFilterWeight:.7,canvasProps:{width:690,height:300,className:"border border-border rounded bg-background w-full",style:{cursor:"crosshair"}},onEnd:R})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(d,{variant:"outline",onClick:()=>{var s;(s=x.current)==null||s.clear(),R()},children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),"Clear"]}),e.jsx(d,{variant:"outline",onClick:()=>S(!1),children:"Cancel"}),e.jsx(d,{onClick:pe,disabled:B,children:B?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"mr-2 h-4 w-4"}),"Save Signature"]})})]})]})]})})]})}export{is as default};
